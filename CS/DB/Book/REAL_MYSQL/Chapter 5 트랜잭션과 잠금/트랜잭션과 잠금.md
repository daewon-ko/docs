# 트랜잭션과 잠금



### 5.2 MySQL 엔진의 잠금

* MYSQL에서 사용되는 잠금
  * 스토리지 엔진 레벨
    * 데이터가 물리적으로 저장되고 관리되는 방식을 정의하는 구성 요소
    * Ex) InnoDB, MyISAM, Memory 등
  * MySQL 엔진 레벨
    * DBMS 자체를 의미.
* Mysql 엔진 레벨의 잠금 -> 스토리지 엔진에 영향을 미치지만, 스토리지 엔진 레벨의 잠금은 스토리지 엔진 간 상호 영향을 미치지 않는다. 

### 5.2.1 글로벌 락

* MySQL에서 제공하는 잠금 중에서 가장 범위가 크다. 

* 명령어  : <b>'FLUSH TABLES WITH READ LOCK'</b>

* 한 세션에서 글로벌 락을 획득하면 다른 세션에서는 SELECT를 제외한 DDL, DML이 글로벌 락이 해제될때까지 대기

* MySQL 서버 전체에 영향을 미치며 작업 대상 테이블이나 데이터베이스가 다르더라도 영향을 미침. 

  * mysqldump로 일관된 백업을 받아야할때 글로벌 락을 사용
    * 실 운영으로 사용되는 MySQL서버에서는 가급적 사용하지 않는 것을 권장 <- 장시간 실행되는 쿼리와 'FLUSH TABLES WITH READ LOCK' 명령이 최악의 케이스로 실행되면 MYSQL 서버의 모든 테이블에대한 쓰기작업이 오래동안 실행불가할 수 있음.

* 8.0부터 InnoDB가 기본 스토리지 엔진으로 설정되며 해당 스토리지는 트랜잭션을 기본으로 제공함에따라서 조금 더 가벼운 글로벌 락의 필요성 대두

  * ##### 백업락

    * 명령어 : <b>'LOCK INSTANCE FOR BACK UP'</b>

    * 툴

      * Xtrabackup

      * Enterprise Backup

    * 특정 세션에서 백업락을 획득시, 모든 세션에서 테이블의 스키마 및 사용자 인증관련 정보 변경 불가
    * 읽기 작업은 가능

### 5.2.1 테이블 락

* 명시적 테이블 락
  * 명령어 : 'Lock Tables table_name [Read \ WRITE ]'
  * InnoDB, MyIsam 엔진 등에서 사용가능
  * 특별한 상황이 아니면 Application 차원에서 설정할 일 거의 없음
* 묵시적 테이블 락
  * MyIsam, Memory 엔진 등에서는 테이블에 데이터를 변경하는 쿼리가 실행되면 자동적으로 해당 테이블을 잠금
  * 쿼리 실행되는 동안 자동으로 획득되었다가 쿼리가 완료되면 자동으로 해제된다.
  * Inno DB -> 스토리지 엔진 차원에서 레코드 기반의 잠금을 제공하기 때문에 묵시적 테이블 락이 설정되지는 않음
    * DML은 해당되지 않고, 스키마 변경과 같은 DDL에 대해서만 테이블이 잠기게 된다. 

### 5.2.3 네임드 락

* 임의의 문자열에 대해 잠금 설정
  * GET_LOCK() 함수
  * 자주 사용되지 않으나 아래와 같은 상황에서 사용가능
  * Ex) DB 서버 1대에 5대의 웹서버가 계속 서비스하는 상황에서 웹 서버가 어떤 정보를 동기화 해야하는가? 

​		

